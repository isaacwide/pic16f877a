#include <16f877a.h>
#fuses XT,NOWDT
#use delay(clock=4M)
#use fast_io(B)
#use fast_io(C)

#define lcd_rs_pin     pin_d0
#define lcd_rw_pin     pin_d1
#define lcd_enable_pin pin_d2
#define lcd_data4      pin_d4
#define lcd_data5      pin_d5
#define lcd_data6      pin_d6
#define lcd_data7      pin_d7
#include <lcd.c>

const char TECLAS[4][4] = {
    {'1', '2', '3', 'A'},
    {'4', '5', '6', 'B'},
    {'7', '8', '9', 'C'},
    {'*', '0', '#', 'D'}
};

// Beep simple
void beep_corto(){
    output_high(PIN_C4);
    delay_ms(50);
    output_low(PIN_C4);
}

// Beep doble
void beep_doble(){
    output_high(PIN_C4);
    delay_ms(50);
    output_low(PIN_C4);
    delay_ms(30);
    output_high(PIN_C4);
    delay_ms(50);
    output_low(PIN_C4);
}

// Beep largo
void beep_largo(){
    output_high(PIN_C4);
    delay_ms(200);
    output_low(PIN_C4);
}

// Beep triple rápido
void beep_triple(){
     int i ;
    for( i = 0; i < 3; i++){
        output_high(PIN_C4);
        delay_ms(30);
        output_low(PIN_C4);
        delay_ms(20);
    }
}



char digito(){
    int i;
    for(i = 0; i < 4; i++){
        // Primero ponemos TODAS las filas en HIGH
        
        // Luego ponemos UNA fila en LOW
        if (i == 0) output_b(0b00001110); // B0=0, resto=1
        if (i == 1) output_b(0b00001101); // B1=0, resto=1
        if (i == 2) output_b(0b00001011); // B2=0, resto=1
        if (i == 3) output_b(0b00000111); // B3=0, resto=1
        
        delay_us(100); // Tiempo de estabilización
        
        // Leemos las columnas
        if(!input(PIN_B4)){
            while(!input(PIN_B4)); // Espera a que suelte
            delay_ms(50);          // Anti-rebote
            return TECLAS[i][0];
        }
        
        if(!input(PIN_B5)){
            while(!input(PIN_B5));
            delay_ms(50);
            return TECLAS[i][1];
        }
        
        if(!input(PIN_B6)){
            while(!input(PIN_B6));
            delay_ms(50);
            return TECLAS[i][2];
        }
        
        if(!input(PIN_B7)){
            while(!input(PIN_B7));
            delay_ms(50);
            return TECLAS[i][3];
        }
    }
    
    return 0; // ? FUERA del for
}

void main(){
    set_tris_b(0b11110000); // B0-B3 salidad , B4-B7 entradas 
    set_tris_c(0b00000000);
    port_b_pullups(true);
    lcd_init();
    
   ;
    while(true){
    
       
        lcd_gotoxy(1,1);
        printf(lcd_putc, "Tecla = ");
        
        char k = digito();
        
        if(k != 0){
            lcd_gotoxy(9,1);
            switch(k){
                case '1': case '2': case '3':
                    beep_corto();
                    break;
                case '4': case '5': case '6':
                    beep_doble();
                    break;
                case '7': case '8': case '9':
                    beep_triple();
                    break;
                case '0':
                    beep_largo();
                    break;
                case '*':
                    beep_triple();
                    break;
                case '#':
                    beep_largo();
                    beep_corto();
                    break;
                case 'A': case 'B': case 'C': case 'D':
                    beep_doble();
                    delay_ms(50);
                    beep_corto();
                    break;
            }
            lcd_putc(k);
            lcd_putc(' ');
        }
    }
}
